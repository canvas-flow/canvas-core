# Canvas Core æ–‡æ¡£ç´¢å¼•

æ¬¢è¿ä½¿ç”¨ Canvas Coreï¼æœ¬æ–‡æ¡£é›†åˆå°†å¸®åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹å¹¶æ·±å…¥ç†è§£ Canvas Core çš„ API å’Œæ¶æ„ã€‚

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### ğŸš€ å¿«é€Ÿå¼€å§‹

- **[API é€ŸæŸ¥è¡¨](./API-CHEATSHEET.md)** - æœ€å¸¸ç”¨çš„ API å‡½æ•°å’Œä½¿ç”¨åœºæ™¯
  - é€‚åˆå¿«é€ŸæŸ¥æ‰¾å’Œæ—¥å¸¸å¼€å‘
  - åŒ…å«å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
  - æ¨èå…ˆä»è¿™é‡Œå¼€å§‹

### ğŸ“– è¯¦ç»†æ–‡æ¡£

- **[å®Œæ•´ API æ–‡æ¡£](./API.md)** - æ‰€æœ‰ API å‡½æ•°çš„è¯¦ç»†è¯´æ˜
  - å‡½æ•°ç­¾åå’Œå‚æ•°è¯´æ˜
  - è¿”å›å€¼ç±»å‹
  - ä½¿ç”¨ç¤ºä¾‹
  - æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ
  - API åˆ†ç±»å’Œæ¨èç­‰çº§

- **[ç±»å‹å®šä¹‰å‚è€ƒ](./TYPES.md)** - TypeScript ç±»å‹å®šä¹‰
  - `CanvasFlowHandle` æ¥å£
  - `CanvasFlowProps` æ¥å£
  - æ•°æ®ç»“æ„ç±»å‹ï¼ˆNodeã€Edgeã€Groupï¼‰
  - é…ç½®ç±»å‹
  - ä½¿ç”¨ç¤ºä¾‹

---

## ğŸ¯ æŒ‰éœ€æ±‚æŸ¥æ‰¾

### æˆ‘æƒ³è¦...

#### å¿«é€ŸæŸ¥æ‰¾æŸä¸ª API
ğŸ‘‰ **[API é€ŸæŸ¥è¡¨](./API-CHEATSHEET.md)**

#### äº†è§£ API çš„è¯¦ç»†ç”¨æ³•
ğŸ‘‰ **[å®Œæ•´ API æ–‡æ¡£](./API.md)**

#### æŸ¥çœ‹ç±»å‹å®šä¹‰
ğŸ‘‰ **[ç±»å‹å®šä¹‰å‚è€ƒ](./TYPES.md)**

#### å®ç°èŠ‚ç‚¹æ‰§è¡Œæµç¨‹
ğŸ‘‰ **[API é€ŸæŸ¥è¡¨ - å…¸å‹åœºæ™¯](./API-CHEATSHEET.md#ğŸ’¡-å…¸å‹åœºæ™¯)**

#### å®ç°è‡ªå®šä¹‰ Inspector
ğŸ‘‰ **[API é€ŸæŸ¥è¡¨ - æ¡ä»¶æ¸²æŸ“ Inspector](./API-CHEATSHEET.md#æ¡ä»¶æ¸²æŸ“-inspector)**

#### ç®¡ç†èŠ‚ç‚¹çŠ¶æ€ï¼ˆloading/errorï¼‰
ğŸ‘‰ **[API æ–‡æ¡£ - çŠ¶æ€ç®¡ç†](./API.md#çŠ¶æ€ç®¡ç†)**

---

## ğŸ—ï¸ æ¶æ„æ–‡æ¡£

### æ ¸å¿ƒæ¦‚å¿µ

#### 1. **çŠ¶æ€åˆ†ç¦»æ¶æ„**

Canvas Core 2.0 é‡‡ç”¨äº†å…¨æ–°çš„çŠ¶æ€åˆ†ç¦»æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Canvas Core                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  mediaMapRef (åª’ä½“å†…å®¹)          â”‚   â”‚
â”‚  â”‚  - src, text, outputData         â”‚   â”‚
â”‚  â”‚  - _loading, _error (UIçŠ¶æ€)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             React Flow                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  structureJson (ç»“æ„æ•°æ®)         â”‚   â”‚
â”‚  â”‚  - nodes, edges, groups          â”‚   â”‚
â”‚  â”‚  - position, size, connections   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Demo Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  nodeConfigStore (ä¸šåŠ¡é…ç½®)      â”‚   â”‚
â”‚  â”‚  - params, prompt, title         â”‚   â”‚
â”‚  â”‚  - inspector config              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿:**
- âœ… æ¸…æ™°çš„èŒè´£è¾¹ç•Œ
- âœ… é˜²æ­¢æ•°æ®æ±¡æŸ“
- âœ… æ›´å¥½çš„æ€§èƒ½ï¼ˆç²¾ç¡®æ›´æ–°ï¼‰
- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•

---

#### 2. **è¯­ä¹‰åŒ– API è®¾è®¡**

**æ—§æ–¹å¼ï¼ˆä¸æ¨èï¼‰:**
```typescript
flowRef.current.updateNodeMedia(nodeId, { src: 'xxx' });
```

**æ–°æ–¹å¼ï¼ˆæ¨èï¼‰:**
```typescript
flowRef.current.setNodeImage(nodeId, 'xxx');
flowRef.current.setNodeVideo(nodeId, 'xxx');
flowRef.current.setNodeText(nodeId, 'hello');
```

**ä¼˜åŠ¿:**
- âœ… æ›´æ¸…æ™°çš„è¯­ä¹‰
- âœ… ç±»å‹å®‰å…¨ï¼ˆè‡ªåŠ¨éªŒè¯èŠ‚ç‚¹ç±»å‹ï¼‰
- âœ… å‚æ•°éªŒè¯ï¼ˆåªæ¥å—åˆæ³•å‚æ•°ï¼‰
- âœ… AI ç¼–ç¨‹å‹å¥½ï¼ˆæ›´å®¹æ˜“ç†è§£å’Œç”Ÿæˆï¼‰

---

#### 3. **Render Props æ¨¡å¼**

Core å±‚ä¸å†åŒ…å« Inspector ç»„ä»¶ï¼Œè€Œæ˜¯é€šè¿‡ Render Props è®© Demo å±‚è‡ªå®šä¹‰ï¼š

```typescript
// Core æä¾›å®¹å™¨
<NodeToolbar>
  {renderNodeInspector?.({ nodeId, node })}
</NodeToolbar>

// Demo æä¾›å†…å®¹
const renderNodeInspector = ({ nodeId, node }) => (
  <MyCustomInspector 
    nodeId={nodeId}
    config={myConfigStore.get(nodeId)}
  />
);
```

**ä¼˜åŠ¿:**
- âœ… å®Œå…¨è§£è€¦ UI å’Œé€»è¾‘
- âœ… Demo å±‚å¯ä»¥è‡ªç”±å®šåˆ¶
- âœ… Core å±‚æ›´è½»é‡
- âœ… æ›´å¥½çš„çµæ´»æ€§

---

## ğŸ“Š API åˆ†ç±»

### ğŸŸ¢ æ¨èä½¿ç”¨ï¼ˆè¯­ä¹‰åŒ–ã€ç±»å‹å®‰å…¨ï¼‰
| API | ç”¨é€” | æ–‡æ¡£é“¾æ¥ |
|-----|------|---------|
| `setNodeImage` | è®¾ç½®å›¾ç‰‡ URL | [è¯¦æƒ…](./API.md#setnodeimage) |
| `setNodeVideo` | è®¾ç½®è§†é¢‘ URL | [è¯¦æƒ…](./API.md#setnodevideo) |
| `setNodeAudio` | è®¾ç½®éŸ³é¢‘ URL | [è¯¦æƒ…](./API.md#setnodeaudio) |
| `setNodeText` | è®¾ç½®æ–‡æœ¬å†…å®¹ | [è¯¦æƒ…](./API.md#setnodetext) |
| `setNodeOutput` | è®¾ç½®è¾“å‡ºæ•°æ® | [è¯¦æƒ…](./API.md#setnodeoutput) |
| `setNodeLoading` | è®¾ç½®åŠ è½½çŠ¶æ€ | [è¯¦æƒ…](./API.md#setnodeloading) |
| `clearNodeLoading` | æ¸…é™¤åŠ è½½çŠ¶æ€ | [è¯¦æƒ…](./API.md#clearnodeloading) |
| `setNodeError` | è®¾ç½®é”™è¯¯çŠ¶æ€ | [è¯¦æƒ…](./API.md#setnodeerror) |
| `clearNodeError` | æ¸…é™¤é”™è¯¯çŠ¶æ€ | [è¯¦æƒ…](./API.md#clearnodeerror) |
| `getNode` | è·å–èŠ‚ç‚¹ä¿¡æ¯ | [è¯¦æƒ…](./API.md#getnode) |
| `getUpstreamNodes` | è·å–ä¸Šæ¸¸èŠ‚ç‚¹ | [è¯¦æƒ…](./API.md#getupstreamnodes) |

### ğŸŸ¡ è°¨æ…ä½¿ç”¨ï¼ˆé€šç”¨æ–¹æ³•ï¼‰
| API | ç”¨é€” | æ›¿ä»£æ–¹æ¡ˆ |
|-----|------|---------|
| `setNodeContent` | è®¾ç½®ä»»æ„å†…å®¹ | ä¼˜å…ˆä½¿ç”¨ä¸“ç”¨æ–¹æ³• |
| `getNodeMedia` | è·å–åª’ä½“æ•°æ® | æŒ‰éœ€ä½¿ç”¨ |

### ğŸ”´ ä¸æ¨èï¼ˆå…¼å®¹æ€§ APIï¼‰
| API | é—®é¢˜ | æ›¿ä»£æ–¹æ¡ˆ |
|-----|------|---------|
| `updateNodeMedia` | è¯­ä¹‰ä¸æ¸…æ™° | `setNodeImage` ç­‰ä¸“ç”¨æ–¹æ³• |
| `batchUpdateNodeMedia` | ç¼ºä¹ç±»å‹å®‰å…¨ | é€ä¸ªè°ƒç”¨ä¸“ç”¨æ–¹æ³• |
| `updateNodeStatus` | å·²åºŸå¼ƒ | `setNodeLoading` / `clearNodeLoading` |

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä¼˜å…ˆä½¿ç”¨ä¸“ç”¨æ–¹æ³•
```typescript
// âœ… å¥½çš„åšæ³•
flowRef.current.setNodeImage(nodeId, imageUrl);
flowRef.current.setNodeText(nodeId, text);

// âŒ ä¸æ¨è
flowRef.current.updateNodeMedia(nodeId, { src: imageUrl });
```

### 2. å®Œæ•´çš„çŠ¶æ€ç®¡ç†
```typescript
// âœ… å®Œæ•´çš„æ‰§è¡Œæµç¨‹
flowRef.current.setNodeLoading(nodeId);

try {
  const result = await executeNode(nodeId);
  flowRef.current.setNodeOutput(nodeId, result);
  flowRef.current.clearNodeLoading(nodeId);
} catch (error) {
  flowRef.current.clearNodeLoading(nodeId);
  flowRef.current.setNodeError(nodeId, error.message);
}
```

### 3. èŠ‚ç‚¹éªŒè¯
```typescript
// âœ… éªŒè¯èŠ‚ç‚¹å­˜åœ¨
const node = flowRef.current.getNode(nodeId);
if (!node) {
  console.warn('èŠ‚ç‚¹ä¸å­˜åœ¨');
  return;
}

// ä½¿ç”¨èŠ‚ç‚¹ä¿¡æ¯
if (node.type === 'image') {
  flowRef.current.setNodeImage(nodeId, newUrl);
}
```

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### å­—æ®µç™½åå•ä¿æŠ¤
æ‰€æœ‰åª’ä½“å†…å®¹è®¾ç½®éƒ½ä¼šç»è¿‡ç™½åå•éªŒè¯ï¼Œé˜²æ­¢éæ³•å­—æ®µæ±¡æŸ“æ•°æ®ï¼š

```typescript
const WHITELIST = [
  'src',
  'text', 
  'outputData',
  'fileName',
  'fileType',
  'responseData'
];
```

### ç±»å‹éªŒè¯
ä¸“ç”¨æ–¹æ³•ä¼šè‡ªåŠ¨éªŒè¯èŠ‚ç‚¹ç±»å‹ï¼Œé˜²æ­¢ç±»å‹é”™è¯¯ï¼š

```typescript
// å¦‚æœ node-1 ä¸æ˜¯ video ç±»å‹
flowRef.current.setNodeVideo('node-1', videoUrl);
// âš ï¸ è‡ªåŠ¨è­¦å‘Š: ç±»å‹ä¸åŒ¹é…
```

---

## ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯

- **å½“å‰ç‰ˆæœ¬**: 2.0
- **ä¸Šæ¬¡é‡æ„**: 2025-12-09
- **ä¸»è¦å˜æ›´**: Inspector å‰¥ç¦»ã€API è¯­ä¹‰åŒ–ã€çŠ¶æ€åˆ†ç¦»

### è¿ç§»æŒ‡å—

ä» 1.x è¿ç§»åˆ° 2.0ï¼š

| 1.x API | 2.0 API | è¯´æ˜ |
|---------|---------|------|
| `updateNodeMedia(id, {src})` | `setNodeImage(id, src)` | ä½¿ç”¨ä¸“ç”¨æ–¹æ³• |
| `updateNodeStatus(id, 'running')` | `setNodeLoading(id)` | æ–°çš„çŠ¶æ€ç®¡ç† |
| `node.data.params` | `configStore.get(id).params` | ä¸šåŠ¡é…ç½®åˆ†ç¦»åˆ° Demo å±‚ |
| `config.nodeDefinitions[x].inspector` | Demo å±‚ç®¡ç† | Inspector é…ç½®åˆ†ç¦» |

---

## ğŸ¤ è´¡çŒ®å’Œåé¦ˆ

- **Issues**: åœ¨ GitHub æäº¤é—®é¢˜
- **Pull Requests**: æ¬¢è¿è´¡çŒ®ä»£ç 
- **æ–‡æ¡£æ”¹è¿›**: å‘ç°æ–‡æ¡£é—®é¢˜è¯·æ PR

---

## ğŸ“ è”ç³»æ–¹å¼

- **ç»´æŠ¤å›¢é˜Ÿ**: Canvas Core Team
- **æ–‡æ¡£æ›´æ–°**: 2025-12-09

---

## ğŸ”— å¤–éƒ¨èµ„æº

- [React Flow æ–‡æ¡£](https://reactflow.dev/)
- [TypeScript æ–‡æ¡£](https://www.typescriptlang.org/)
- [Radix UI](https://www.radix-ui.com/)

---

**å¿«é€Ÿé“¾æ¥:**
- [API é€ŸæŸ¥è¡¨](./API-CHEATSHEET.md) - æ—¥å¸¸å¼€å‘é¦–é€‰
- [å®Œæ•´ API æ–‡æ¡£](./API.md) - è¯¦ç»†å‚è€ƒ
- [ç±»å‹å®šä¹‰](./TYPES.md) - TypeScript ç±»å‹

---

**ç¥å¼€å‘æ„‰å¿«ï¼** ğŸ‰



















