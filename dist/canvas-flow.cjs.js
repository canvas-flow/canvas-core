var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),s=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,u=c.length,d;l<u;l++)d=c[l],!a.call(e,d)&&d!==o&&t(e,d,{get:(e=>i[e]).bind(null,d),enumerable:!(s=n(i,d))||s.enumerable});return e},c=(n,r,a)=>(a=n==null?{}:e(i(n)),s(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));let l=require(`react`);l=c(l);let u=require(`@xyflow/react`),d=require(`react-dom`);var f=e=>e.replace(/([a-z0-9])([A-Z])/g,`$1-$2`).toLowerCase(),p=(...e)=>e.filter((e,t,n)=>!!e&&e.trim()!==``&&n.indexOf(e)===t).join(` `).trim(),m={xmlns:`http://www.w3.org/2000/svg`,width:24,height:24,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:2,strokeLinecap:`round`,strokeLinejoin:`round`},h=(0,l.forwardRef)(({color:e=`currentColor`,size:t=24,strokeWidth:n=2,absoluteStrokeWidth:r,className:i=``,children:a,iconNode:o,...s},c)=>(0,l.createElement)(`svg`,{ref:c,...m,width:t,height:t,stroke:e,strokeWidth:r?Number(n)*24/Number(t):n,className:p(`lucide`,i),...s},[...o.map(([e,t])=>(0,l.createElement)(e,t)),...Array.isArray(a)?a:[a]])),g=(e,t)=>{let n=(0,l.forwardRef)(({className:n,...r},i)=>(0,l.createElement)(h,{ref:i,iconNode:t,className:p(`lucide-${f(e)}`,n),...r}));return n.displayName=`${e}`,n},_=g(`ChevronRight`,[[`path`,{d:`m9 18 6-6-6-6`,key:`mthhwq`}]]),v=g(`Clipboard`,[[`rect`,{width:`8`,height:`4`,x:`8`,y:`2`,rx:`1`,ry:`1`,key:`tgr4d6`}],[`path`,{d:`M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2`,key:`116196`}]]),y=g(`Copy`,[[`rect`,{width:`14`,height:`14`,x:`8`,y:`8`,rx:`2`,ry:`2`,key:`17jyea`}],[`path`,{d:`M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2`,key:`zix9uf`}]]),ee=g(`FolderInput`,[[`path`,{d:`M2 9V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-1`,key:`fm4g5t`}],[`path`,{d:`M2 13h10`,key:`pgb2dq`}],[`path`,{d:`m9 16 3-3-3-3`,key:`6m91ic`}]]),b=g(`Group`,[[`path`,{d:`M3 7V5c0-1.1.9-2 2-2h2`,key:`adw53z`}],[`path`,{d:`M17 3h2c1.1 0 2 .9 2 2v2`,key:`an4l38`}],[`path`,{d:`M21 17v2c0 1.1-.9 2-2 2h-2`,key:`144t0e`}],[`path`,{d:`M7 21H5c-1.1 0-2-.9-2-2v-2`,key:`rtnfgi`}],[`rect`,{width:`7`,height:`5`,x:`7`,y:`7`,rx:`1`,key:`1eyiv7`}],[`rect`,{width:`7`,height:`5`,x:`10`,y:`12`,rx:`1`,key:`1qlmkx`}]]),x=g(`Image`,[[`rect`,{width:`18`,height:`18`,x:`3`,y:`3`,rx:`2`,ry:`2`,key:`1m3agn`}],[`circle`,{cx:`9`,cy:`9`,r:`2`,key:`af1f0g`}],[`path`,{d:`m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21`,key:`1xmnt7`}]]),S=g(`Layers`,[[`path`,{d:`M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z`,key:`zw3jo`}],[`path`,{d:`M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12`,key:`1wduqc`}],[`path`,{d:`M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17`,key:`kqbvx6`}]]),C=g(`LoaderCircle`,[[`path`,{d:`M21 12a9 9 0 1 1-6.219-8.56`,key:`13zald`}]]),w=g(`MousePointerClick`,[[`path`,{d:`M14 4.1 12 6`,key:`ita8i4`}],[`path`,{d:`m5.1 8-2.9-.8`,key:`1go3kf`}],[`path`,{d:`m6 12-1.9 2`,key:`mnht97`}],[`path`,{d:`M7.2 2.2 8 5.1`,key:`1cfko1`}],[`path`,{d:`M9.037 9.69a.498.498 0 0 1 .653-.653l11 4.5a.5.5 0 0 1-.074.949l-4.349 1.041a1 1 0 0 0-.74.739l-1.04 4.35a.5.5 0 0 1-.95.074z`,key:`s0h3yz`}]]),T=g(`Music`,[[`path`,{d:`M9 18V5l12-2v13`,key:`1jmyc2`}],[`circle`,{cx:`6`,cy:`18`,r:`3`,key:`fqmcym`}],[`circle`,{cx:`18`,cy:`16`,r:`3`,key:`1hluhg`}]]),E=g(`PenLine`,[[`path`,{d:`M12 20h9`,key:`t2du7b`}],[`path`,{d:`M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z`,key:`1ykcvy`}]]),D=g(`Play`,[[`polygon`,{points:`6 3 20 12 6 21 6 3`,key:`1oa8hb`}]]),O=g(`Plus`,[[`path`,{d:`M5 12h14`,key:`1ays0h`}],[`path`,{d:`M12 5v14`,key:`s699le`}]]),k=g(`Save`,[[`path`,{d:`M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z`,key:`1c8476`}],[`path`,{d:`M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7`,key:`1ydtos`}],[`path`,{d:`M7 3v4a1 1 0 0 0 1 1h7`,key:`t51u73`}]]),A=g(`Sparkles`,[[`path`,{d:`M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z`,key:`4pj2yx`}],[`path`,{d:`M20 3v4`,key:`1olli1`}],[`path`,{d:`M22 5h-4`,key:`1gvqau`}],[`path`,{d:`M4 17v2`,key:`vumght`}],[`path`,{d:`M5 18H3`,key:`zchphs`}]]),j=g(`Trash2`,[[`path`,{d:`M3 6h18`,key:`d0wm0j`}],[`path`,{d:`M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6`,key:`4alrt4`}],[`path`,{d:`M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2`,key:`v07s0e`}],[`line`,{x1:`10`,x2:`10`,y1:`11`,y2:`17`,key:`1uufr5`}],[`line`,{x1:`14`,x2:`14`,y1:`11`,y2:`17`,key:`xtxkd`}]]),M=g(`Ungroup`,[[`rect`,{width:`8`,height:`6`,x:`5`,y:`4`,rx:`1`,key:`nzclkv`}],[`rect`,{width:`8`,height:`6`,x:`11`,y:`14`,rx:`1`,key:`4tytwb`}]]),N=g(`Upload`,[[`path`,{d:`M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4`,key:`ih7n3h`}],[`polyline`,{points:`17 8 12 3 7 8`,key:`t8dd8p`}],[`line`,{x1:`12`,x2:`12`,y1:`3`,y2:`15`,key:`widbto`}]]),P=g(`Video`,[[`path`,{d:`m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5`,key:`ftymec`}],[`rect`,{x:`2`,y:`6`,width:`14`,height:`12`,rx:`2`,key:`158x01`}]]),F=g(`X`,[[`path`,{d:`M18 6 6 18`,key:`1bl5f8`}],[`path`,{d:`m6 6 12 12`,key:`d8bk6v`}]]);const I=(e=`node`)=>`${e}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,te=(e,t=[])=>{let n=new Map(t.map(e=>[e.id,e])),r=e.map(e=>{let t=e.groupId,r=t?n.get(t):void 0,i=e.position,a;return r&&(a=r.id,i=e._coordinateType===`absolute`?{x:e.position.x-r.position.x,y:e.position.y-r.position.y}:e.position),{id:e.id,type:e.type,position:i,parentId:a,extent:a?`parent`:void 0,expandParent:!0,draggable:!0,zIndex:10,width:e.width||250,height:e.height||250,style:{width:e.width?`${e.width}px`:`250px`,height:e.height?`${e.height}px`:`250px`},data:{}}});return[...t.map(e=>({id:e.id,type:`group`,position:e.position,zIndex:-1,draggable:!0,width:e.width,height:e.height,style:{width:e.width,height:e.height},data:{label:e.label,style:e.style}})),...r]},L=(e,t=[])=>{let n=[],r=[],i=new Map(t.map(e=>[e.id,e])),a=new Map;return e.forEach(e=>{if(e.type===`group`){a.set(e.id,{position:e.position});let t=i.get(e.id);r.push({id:e.id,label:t?.label||`Group`,position:e.position,width:e.measured?.width||e.width||200,height:e.measured?.height||e.height||100,style:t?.style})}}),e.forEach(e=>{if(e.type===`group`)return;let t=e.position,r=e.parentId;if(r){let n=a.get(r);n&&(t={x:e.position.x+n.position.x,y:e.position.y+n.position.y})}n.push({id:e.id,type:e.type||`default`,position:t,width:e.measured?.width||e.width||250,height:e.measured?.height||e.height||250,groupId:r,_coordinateType:`absolute`})}),{nodes:n,groups:r}},ne=e=>e.map(e=>({id:e.id,source:e.source,target:e.target,sourceHandle:e.sourceHandle,targetHandle:e.targetHandle,data:e.data,markerEnd:{type:u.MarkerType.ArrowClosed,width:20,height:20,color:`#888`}})),re=e=>e.map(e=>({id:e.id,source:e.source,target:e.target,sourceHandle:e.sourceHandle,targetHandle:e.targetHandle,data:e.data})),R=e=>{if(e.length===0)return{x:0,y:0,width:0,height:0};let t=1/0,n=1/0,r=-1/0,i=-1/0;return e.forEach(e=>{let a=e.width||200,o=e.height||40;t=Math.min(t,e.position.x),n=Math.min(n,e.position.y),r=Math.max(r,e.position.x+a),i=Math.max(i,e.position.y+o)}),{x:t,y:n,width:r-t,height:i-n}},ie=(e,t,n)=>{let{source:r,target:i}=n;if(r===i)return!1;let a=new Map;e.forEach(e=>a.set(e.id,[])),t.forEach(e=>{let t=a.get(e.source)||[];t.push(e.target),a.set(e.source,t)});let o=new Set,s=[i];for(;s.length>0;){let e=s.pop();if(e===r)return!1;if(!o.has(e)){o.add(e);let t=a.get(e)||[];for(let e of t)s.push(e)}}return!0};let z=function(e){return e.TEXT=`text`,e.IMAGE=`image`,e.VIDEO=`video`,e.AUDIO=`audio`,e.UPLOAD=`user-upload`,e}({});var B=o((e=>{var t=Symbol.for(`react.transitional.element`),n=Symbol.for(`react.fragment`);function r(e,n,r){var i=null;if(r!==void 0&&(i=``+r),n.key!==void 0&&(i=``+n.key),`key`in n)for(var a in r={},n)a!==`key`&&(r[a]=n[a]);else r=n;return n=r.ref,{$$typeof:t,type:e,key:i,ref:n===void 0?null:n,props:r}}e.Fragment=n,e.jsx=r,e.jsxs=r})),V=o((e=>{process.env.NODE_ENV!==`production`&&(function(){function t(e){if(e==null)return null;if(typeof e==`function`)return e.$$typeof===D?null:e.displayName||e.name||null;if(typeof e==`string`)return e;switch(e){case _:return`Fragment`;case y:return`Profiler`;case v:return`StrictMode`;case S:return`Suspense`;case C:return`SuspenseList`;case E:return`Activity`}if(typeof e==`object`)switch(typeof e.tag==`number`&&console.error(`Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue.`),e.$$typeof){case g:return`Portal`;case b:return e.displayName||`Context`;case ee:return(e._context.displayName||`Context`)+`.Consumer`;case x:var n=e.render;return e=e.displayName,e||=(e=n.displayName||n.name||``,e===``?`ForwardRef`:`ForwardRef(`+e+`)`),e;case w:return n=e.displayName||null,n===null?t(e.type)||`Memo`:n;case T:n=e._payload,e=e._init;try{return t(e(n))}catch{}}return null}function n(e){return``+e}function r(e){try{n(e);var t=!1}catch{t=!0}if(t){t=console;var r=t.error,i=typeof Symbol==`function`&&Symbol.toStringTag&&e[Symbol.toStringTag]||e.constructor.name||`Object`;return r.call(t,`The provided key is an unsupported type %s. This value must be coerced to a string before using it here.`,i),n(e)}}function i(e){if(e===_)return`<>`;if(typeof e==`object`&&e&&e.$$typeof===T)return`<...>`;try{var n=t(e);return n?`<`+n+`>`:`<...>`}catch{return`<...>`}}function a(){var e=O.A;return e===null?null:e.getOwner()}function o(){return Error(`react-stack-top-frame`)}function s(e){if(k.call(e,`key`)){var t=Object.getOwnPropertyDescriptor(e,`key`).get;if(t&&t.isReactWarning)return!1}return e.key!==void 0}function c(e,t){function n(){M||(M=!0,console.error("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://react.dev/link/special-props)",t))}n.isReactWarning=!0,Object.defineProperty(e,`key`,{get:n,configurable:!0})}function l(){var e=t(this.type);return N[e]||(N[e]=!0,console.error(`Accessing element.ref was removed in React 19. ref is now a regular prop. It will be removed from the JSX Element type in a future release.`)),e=this.props.ref,e===void 0?null:e}function u(e,t,n,r,i,a){var o=n.ref;return e={$$typeof:h,type:e,key:t,props:n,_owner:r},(o===void 0?null:o)===null?Object.defineProperty(e,`ref`,{enumerable:!1,value:null}):Object.defineProperty(e,`ref`,{enumerable:!1,get:l}),e._store={},Object.defineProperty(e._store,`validated`,{configurable:!1,enumerable:!1,writable:!0,value:0}),Object.defineProperty(e,`_debugInfo`,{configurable:!1,enumerable:!1,writable:!0,value:null}),Object.defineProperty(e,`_debugStack`,{configurable:!1,enumerable:!1,writable:!0,value:i}),Object.defineProperty(e,`_debugTask`,{configurable:!1,enumerable:!1,writable:!0,value:a}),Object.freeze&&(Object.freeze(e.props),Object.freeze(e)),e}function d(e,n,i,o,l,d){var p=n.children;if(p!==void 0)if(o)if(A(p)){for(o=0;o<p.length;o++)f(p[o]);Object.freeze&&Object.freeze(p)}else console.error(`React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.`);else f(p);if(k.call(n,`key`)){p=t(e);var m=Object.keys(n).filter(function(e){return e!==`key`});o=0<m.length?`{key: someKey, `+m.join(`: ..., `)+`: ...}`:`{key: someKey}`,I[p+o]||(m=0<m.length?`{`+m.join(`: ..., `)+`: ...}`:`{}`,console.error(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,o,p,m,p),I[p+o]=!0)}if(p=null,i!==void 0&&(r(i),p=``+i),s(n)&&(r(n.key),p=``+n.key),`key`in n)for(var h in i={},n)h!==`key`&&(i[h]=n[h]);else i=n;return p&&c(i,typeof e==`function`?e.displayName||e.name||`Unknown`:e),u(e,p,i,a(),l,d)}function f(e){p(e)?e._store&&(e._store.validated=1):typeof e==`object`&&e&&e.$$typeof===T&&(e._payload.status===`fulfilled`?p(e._payload.value)&&e._payload.value._store&&(e._payload.value._store.validated=1):e._store&&(e._store.validated=1))}function p(e){return typeof e==`object`&&!!e&&e.$$typeof===h}var m=require(`react`),h=Symbol.for(`react.transitional.element`),g=Symbol.for(`react.portal`),_=Symbol.for(`react.fragment`),v=Symbol.for(`react.strict_mode`),y=Symbol.for(`react.profiler`),ee=Symbol.for(`react.consumer`),b=Symbol.for(`react.context`),x=Symbol.for(`react.forward_ref`),S=Symbol.for(`react.suspense`),C=Symbol.for(`react.suspense_list`),w=Symbol.for(`react.memo`),T=Symbol.for(`react.lazy`),E=Symbol.for(`react.activity`),D=Symbol.for(`react.client.reference`),O=m.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,k=Object.prototype.hasOwnProperty,A=Array.isArray,j=console.createTask?console.createTask:function(){return null};m={react_stack_bottom_frame:function(e){return e()}};var M,N={},P=m.react_stack_bottom_frame.bind(m,o)(),F=j(i(o)),I={};e.Fragment=_,e.jsx=function(e,t,n){var r=1e4>O.recentlyCreatedOwnerStacks++;return d(e,t,n,!1,r?Error(`react-stack-top-frame`):P,r?j(i(e)):F)},e.jsxs=function(e,t,n){var r=1e4>O.recentlyCreatedOwnerStacks++;return d(e,t,n,!0,r?Error(`react-stack-top-frame`):P,r?j(i(e)):F)}})()})),H=o(((e,t)=>{process.env.NODE_ENV===`production`?t.exports=B():t.exports=V()})),U=H(),W=[{type:z.TEXT,label:`æ–‡æœ¬`,icon:(0,U.jsx)(E,{size:16})},{type:z.IMAGE,label:`å›¾ç‰‡`,icon:(0,U.jsx)(x,{size:16})},{type:z.VIDEO,label:`è§†é¢‘`,icon:(0,U.jsx)(P,{size:16})},{type:z.AUDIO,label:`éŸ³é¢‘`,icon:(0,U.jsx)(T,{size:16})},{type:z.UPLOAD,label:`ä¸Šä¼ `,icon:(0,U.jsx)(N,{size:16})}];const ae=({onAddNode:e,availableTypes:t=W,position:n,onClose:r})=>{let[i,a]=(0,l.useState)(!1),o=(0,l.useRef)(null),s=!!n,c=s||i;return(0,l.useEffect)(()=>{if(s&&r){let e=e=>{o.current&&!o.current.contains(e.target)&&r()};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)}},[s,r]),s?(0,U.jsx)(`div`,{ref:o,style:{position:`fixed`,left:n.x,top:n.y,background:`#222`,border:`1px solid #444`,borderRadius:8,padding:8,display:`flex`,flexDirection:`column`,gap:4,boxShadow:`0 4px 20px rgba(0,0,0,0.6)`,zIndex:1e3,minWidth:140},children:t.map(t=>(0,U.jsxs)(`div`,{onClick:()=>{e(t.type),s||a(!1)},style:{padding:`8px 12px`,borderRadius:4,cursor:`pointer`,color:`#eee`,fontSize:14,transition:`background 0.2s`,display:`flex`,alignItems:`center`,gap:10},onMouseEnter:e=>e.currentTarget.style.background=`#444`,onMouseLeave:e=>e.currentTarget.style.background=`transparent`,children:[t.icon,(0,U.jsx)(`span`,{children:t.label})]},t.type))}):(0,U.jsxs)(U.Fragment,{children:[(0,U.jsx)(`div`,{style:{position:`absolute`,left:24,top:`50%`,transform:`translateY(-50%)`,width:48,height:48,borderRadius:`50%`,background:i?`#666`:`#333`,border:`1px solid #444`,color:`#fff`,display:`flex`,alignItems:`center`,justifyContent:`center`,cursor:`pointer`,boxShadow:`0 4px 12px rgba(0,0,0,0.5)`,zIndex:100,transition:`all 0.2s`},onClick:()=>a(!i),onMouseEnter:e=>e.currentTarget.style.background=i?`#666`:`#444`,onMouseLeave:e=>e.currentTarget.style.background=i?`#666`:`#333`,title:`Add Node`,children:(0,U.jsx)(O,{size:24,style:{transform:i?`rotate(45deg)`:`none`,transition:`transform 0.2s`}})}),c&&(0,U.jsx)(`div`,{style:{position:`absolute`,left:84,top:`50%`,transform:`translateY(-50%)`,background:`#222`,border:`1px solid #444`,borderRadius:8,padding:8,display:`flex`,flexDirection:`column`,gap:4,boxShadow:`0 4px 20px rgba(0,0,0,0.6)`,zIndex:100,minWidth:140},children:t.map(t=>(0,U.jsxs)(`div`,{onClick:()=>{e(t.type),a(!1)},style:{padding:`8px 12px`,borderRadius:4,cursor:`pointer`,color:`#eee`,fontSize:14,transition:`background 0.2s`,display:`flex`,alignItems:`center`,gap:10},onMouseEnter:e=>e.currentTarget.style.background=`#444`,onMouseLeave:e=>e.currentTarget.style.background=`transparent`,children:[t.icon,(0,U.jsx)(`span`,{children:t.label})]},t.type))})]})},oe=({items:e,position:t,onClose:n})=>{let r=(0,l.useRef)(null);return(0,l.useEffect)(()=>{let e=e=>{r.current&&!r.current.contains(e.target)&&n()};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)},[n]),(0,U.jsx)(`div`,{ref:r,className:`canvas-context-menu`,style:{position:`fixed`,top:t.y,left:t.x,zIndex:1e3,backgroundColor:`#222`,border:`1px solid #444`,borderRadius:`8px`,boxShadow:`0 4px 20px rgba(0,0,0,0.6)`,padding:`8px`,minWidth:`140px`,display:`flex`,flexDirection:`column`,gap:`4px`},children:e.map((e,t)=>(0,U.jsxs)(`div`,{className:`context-menu-item ${e.disabled?`disabled`:``}`,onClick:()=>{e.disabled||(e.onClick(),n())},style:{padding:`8px 12px`,borderRadius:`4px`,cursor:e.disabled?`not-allowed`:`pointer`,opacity:e.disabled?.5:1,display:`flex`,justifyContent:`space-between`,alignItems:`center`,fontSize:`14px`,color:`#eee`,transition:`background 0.2s`},onMouseEnter:t=>{e.disabled||(t.currentTarget.style.backgroundColor=`#444`)},onMouseLeave:t=>{e.disabled||(t.currentTarget.style.backgroundColor=`transparent`)},children:[(0,U.jsxs)(`div`,{style:{display:`flex`,alignItems:`center`,gap:`8px`},children:[e.icon&&(0,U.jsx)(`span`,{style:{display:`flex`,alignItems:`center`},children:e.icon}),(0,U.jsx)(`span`,{children:e.label})]}),e.shortcut&&(0,U.jsx)(`span`,{style:{color:`#999`,fontSize:`12px`,marginLeft:`10px`},children:e.shortcut})]},t))})};var se=(0,l.createContext)(null);const ce=({children:e,...t})=>(0,U.jsx)(se.Provider,{value:t,children:e}),le=()=>{let e=(0,l.useContext)(se);if(!e)throw Error(`useCanvasContext must be used within a CanvasProvider`);return e},ue=({title:e,defaultTitle:t,onChange:n,className:r=``})=>{let[i,a]=(0,l.useState)(!1),{zoom:o}=(0,u.useViewport)(),s=1/o,c=e||t,d=c.length>15?c.slice(0,15)+`...`:c;return i?(0,U.jsx)(`input`,{className:`nodrag canvas-node-title-input ${r}`,autoFocus:!0,onBlur:()=>a(!1),placeholder:`è¾“å…¥æ ‡é¢˜...`,value:e||``,onChange:e=>{n({title:e.target.value.slice(0,15)})},onKeyDown:e=>{e.stopPropagation(),e.key===`Escape`&&a(!1)},onMouseDown:e=>e.stopPropagation(),style:{position:`absolute`,top:`${-24*s}px`,left:`0`,background:`rgba(0, 0, 0, 0.8)`,border:`1px solid #555`,borderRadius:`4px`,padding:`2px 6px`,color:`#fff`,fontSize:`13px`,fontWeight:`500`,outline:`none`,minWidth:`50px`,maxWidth:`200px`,transform:`scale(${s})`,transformOrigin:`left top`}}):(0,U.jsx)(`div`,{className:`canvas-node-title ${r}`,onDoubleClick:()=>a(!0),title:c,style:{position:`absolute`,top:`${-24*s}px`,left:`0`,color:`#888`,fontSize:`13px`,fontWeight:`500`,whiteSpace:`nowrap`,cursor:`text`,transition:`color 0.2s`,pointerEvents:`auto`,transform:`scale(${s})`,transformOrigin:`left top`},onMouseEnter:e=>{e.currentTarget.style.color=`#ccc`},onMouseLeave:e=>{e.currentTarget.style.color=`#888`},children:d})};function G(e,t){let n=(0,l.useRef)(e),r=(0,l.useRef)(void 0);return(0,l.useEffect)(()=>{n.current=e},[e]),(0,l.useCallback)((...e)=>{r.current&&clearTimeout(r.current),r.current=setTimeout(()=>{n.current(...e)},t)},[t])}const de=(0,l.memo)(e=>{let{id:t,data:n,selected:r,style:i}=e,{config:a,components:o,readOnly:s,onNodeRun:c,runningNodeId:d,isExecuting:f,onNodeDataChange:p,inspectingNodeId:m,mediaMap:h,mediaEmitter:g,updateNodeMedia:_,renderNodeInspector:v}=le(),{setNodes:y,getNode:ee}=(0,u.useReactFlow)(),b=(0,u.useEdges)(),[x,S]=(0,l.useState)(()=>{let e=h.get(t);return e&&Object.keys(e).length>0?e:n||{}});(0,l.useEffect)(()=>{let e=e=>{S(e)};return g.on(t,e),()=>g.off(t,e)},[t,g]);let w=e.type||`default`,T=a.nodeDefinitions.find(e=>e.type===w);if(!T)return(0,U.jsxs)(`div`,{style:{padding:10,border:`1px solid red`,borderRadius:4,background:`#fff0f0`},children:[`Unknown node type: `,w]});let E=o[T.component],D=G((e,t)=>{p&&p(e,t)},500),O=e=>{let n={...x,...e};S(n),h.set(t,n),g.emit(t,n),y(n=>n.map(n=>{if(n.id===t){let r={...n.data,...e};return console.log(`[handleNodeChange] æ›´æ–°èŠ‚ç‚¹æ•°æ®:`,{nodeId:t,newData:e,mergedData:r}),{...n,data:r}}return n})),D(t,e)},k=b.some(e=>e.source===t||e.target===t),A=(0,u.useNodesData)((0,l.useMemo)(()=>b.filter(e=>e.target===t).map(e=>e.source),[b,t]));(0,l.useMemo)(()=>A?(Array.isArray(A)?A:[A]).map(e=>{if(!e)return null;let t=a.nodeDefinitions.find(t=>t.type===e.type);return{id:e.id,type:e.type,label:t?.label,data:e.data}}).filter(e=>!!e):[],[A,a.nodeDefinitions]);let j={nodeId:t,data:{...n,...x},selected:!!r,isConnected:k,onChange:O,onRun:c?()=>c(t):void 0,style:i};return(0,U.jsxs)(`div`,{className:[`canvas-node`,r?`selected`:``,x._error?`error`:``].filter(Boolean).join(` `),style:{width:`100%`,height:`100%`},children:[v&&(0,U.jsx)(u.NodeToolbar,{isVisible:t===m&&!s,position:u.Position.Bottom,children:v({nodeId:t,node:{id:t,type:w,position:{x:0,y:0},data:x}})}),(0,U.jsx)(ue,{title:x.title||``,defaultTitle:T.label,onChange:O}),(0,U.jsx)(u.Handle,{type:`target`,position:u.Position.Left,className:`canvas-handle`}),(0,U.jsxs)(`div`,{className:`canvas-node-body`,style:{position:`relative`},children:[E?(0,U.jsx)(E,{...j}):(0,U.jsxs)(`div`,{style:{padding:10},children:[`Missing Component: `,T.component]}),(x._loading||x._executionStatus===`running`)&&(0,U.jsxs)(`div`,{className:`cf-upload-loading-overlay`,style:{position:`absolute`,top:0,left:0,width:`100%`,height:`100%`,background:`rgba(0,0,0,0.7)`,display:`flex`,flexDirection:`column`,alignItems:`center`,justifyContent:`center`,zIndex:20,color:`#fff`,gap:8,borderRadius:`inherit`},children:[(0,U.jsx)(C,{className:`cf-spinner`,size:24,style:{animation:`spin 1s linear infinite`}}),(0,U.jsx)(`span`,{style:{fontSize:12},children:`Running...`}),(0,U.jsx)(`style`,{children:`@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`})]})]}),x._error&&(0,U.jsxs)(`div`,{className:`cf-node-error-bar`,children:[(0,U.jsx)(`span`,{className:`cf-node-error-icon`,children:`âš ï¸`}),(0,U.jsx)(`span`,{className:`cf-node-error-text`,children:x._error})]}),(0,U.jsx)(u.Handle,{type:`source`,position:u.Position.Right,className:`canvas-handle`})]})}),fe=(0,l.memo)(({id:e,data:t,selected:n})=>{let{setNodes:r}=(0,u.useReactFlow)(),{onGroupAction:i}=le(),{zoom:a}=(0,u.useViewport)(),[o,s]=(0,l.useState)(!1),[c,d]=(0,l.useState)(t.label||`Group`),f=t.style,p=1/a,m=(0,l.useCallback)(()=>{s(!1),r(t=>t.map(t=>t.id===e?{...t,data:{...t.data,label:c}}:t)),i&&i(`update`,{id:e,label:c})},[e,c,r,i]),h=(0,l.useCallback)(t=>{t.stopPropagation(),i&&i(`ungroup`,{id:e})},[e,i]),g=(0,l.useCallback)(t=>{t.stopPropagation(),i&&i(`run`,{id:e})},[e,i]),_=(0,l.useMemo)(()=>[{id:`run`,label:`æ•´ç»„æ‰§è¡Œ`,icon:D,onClick:g,className:`text-green`},{id:`save`,label:`ä¿å­˜`,icon:k,onClick:t=>{t.stopPropagation(),i&&i(`save`,{id:e})}},{id:`ungroup`,label:`è§£ç»„`,icon:M,onClick:h}],[g,h]),v=t.toolbarActions||_,y=(0,l.useCallback)((t,n)=>{i&&i(`update`,{id:e,width:n.width,height:n.height,style:{...f,width:n.width,height:n.height}})},[e,f,i]);return(0,U.jsxs)(`div`,{style:{width:`100%`,height:`100%`,backgroundColor:f?.backgroundColor||`rgba(30, 30, 30, 0.6)`,border:n?`1px solid #ffffff`:`1px solid rgba(255,255,255,0.1)`,borderRadius:12,position:`relative`,transition:`all 0.2s ease`,boxShadow:n?`0 0 0 2px rgba(255, 255, 255, 0.2)`:`none`},children:[(0,U.jsx)(u.NodeResizer,{minWidth:100,minHeight:100,isVisible:!!n,lineStyle:{border:`none`},handleStyle:{width:10,height:10,borderRadius:2},color:`#ffffff`,onResizeEnd:y}),(0,U.jsx)(`div`,{style:{position:`absolute`,top:-24*p,left:0,transform:`scale(${p})`,transformOrigin:`left top`,pointerEvents:`auto`},children:o?(0,U.jsx)(`input`,{autoFocus:!0,value:c,onChange:e=>d(e.target.value),onBlur:m,onKeyDown:e=>e.key===`Enter`&&m(),onMouseDown:e=>e.stopPropagation(),className:`canvas-node-title-input`,style:{position:`static`}}):(0,U.jsx)(`div`,{className:`canvas-node-title`,style:{position:`static`},onDoubleClick:()=>s(!0),children:t.label})}),(0,U.jsx)(`div`,{style:{position:`absolute`,top:-56*p,left:`50%`,transform:`translateX(-50%) scale(${p})`,transformOrigin:`center top`,display:`flex`,alignItems:`center`,justifyContent:`center`,pointerEvents:`none`,opacity:n?1:0,transition:`opacity 0.2s`},children:(0,U.jsx)(`div`,{className:`group-toolbar-capsule`,style:{display:`flex`,alignItems:`center`,background:`#1e1e1e`,borderRadius:20,padding:`6px 8px`,gap:2,boxShadow:`0 4px 16px rgba(0,0,0,0.5)`,border:`1px solid #333`,pointerEvents:n?`auto`:`none`},onMouseDown:e=>e.stopPropagation(),children:v.map(e=>{let t=e.icon,n=e.className?.includes(`text-green`);return(0,U.jsxs)(`button`,{onClick:e.onClick,title:e.title||e.label,style:{display:`flex`,alignItems:`center`,gap:5,padding:`6px 12px`,borderRadius:14,cursor:`pointer`,color:n?`#4ade80`:`#ccc`,fontSize:13,fontWeight:500,border:`none`,background:`transparent`,whiteSpace:`nowrap`,transition:`all 0.15s`},onMouseEnter:e=>{e.currentTarget.style.background=n?`rgba(74, 222, 128, 0.15)`:`#2a2a2a`,e.currentTarget.style.color=n?`#4ade80`:`#fff`},onMouseLeave:e=>{e.currentTarget.style.background=`transparent`,e.currentTarget.style.color=n?`#4ade80`:`#ccc`},children:[e.icon&&(0,U.jsx)(`span`,{style:{display:`flex`,alignItems:`center`},children:l.default.isValidElement(e.icon)?e.icon:(0,U.jsx)(t,{size:14})}),e.label&&(0,U.jsx)(`span`,{children:e.label})]},e.id)})})})]})}),pe=({selectedNodes:e,onCreateGroup:t})=>{let{flowToScreenPosition:n,getNodes:r}=(0,u.useReactFlow)(),i=e.filter(e=>e.type!==`group`);if(i.length<2||i.some(e=>e.parentId))return null;let a=r(),o=new Map(a.map(e=>[e.id,e])),s=R(i.map(e=>{let t=e.position;if(e.parentId){let n=o.get(e.parentId);n&&(t={x:e.position.x+n.position.x,y:e.position.y+n.position.y})}return{position:t,width:e.measured?.width||e.width||0,height:e.measured?.height||e.height||0}})),c=n({x:s.x+s.width/2,y:s.y});return(0,U.jsx)(`div`,{style:{position:`absolute`,left:c.x,top:c.y-40,transform:`translate(-50%, -100%)`,zIndex:2e3,pointerEvents:`all`},children:(0,U.jsxs)(`button`,{onClick:e=>{e.stopPropagation(),t()},style:{display:`flex`,alignItems:`center`,gap:6,padding:`8px 16px`,backgroundColor:`#1a1a1a`,color:`white`,border:`1px solid #333`,borderRadius:20,cursor:`pointer`,boxShadow:`0 4px 12px rgba(0,0,0,0.5)`,fontSize:13,fontWeight:500,outline:`none`},onMouseEnter:e=>e.currentTarget.style.backgroundColor=`#2a2a2a`,onMouseLeave:e=>e.currentTarget.style.backgroundColor=`#1a1a1a`,children:[(0,U.jsx)(b,{size:14}),`ç¼–ç»„`]})})};function me({nodes:e,edges:t,setEdges:n,setNodes:r,onEdgeAdd:i,onNodeAdd:a,config:o,rfInstance:s}){let[c,d]=(0,l.useState)(!1),[f,p]=(0,l.useState)({isOpen:!1,position:{x:0,y:0},source:null}),m=(0,l.useRef)(null),h=(0,l.useCallback)((e,t)=>{let n=o.nodeDefinitions.find(t=>t.type===e),r=o.nodeDefinitions.find(e=>e.type===t);return!n||!r?!0:!(n.connectionRules?.allowedTargets&&!n.connectionRules.allowedTargets.includes(t)||r.connectionRules?.allowedSources&&!r.connectionRules.allowedSources.includes(e))},[o.nodeDefinitions]),g=(0,l.useCallback)(n=>{if(n.source===n.target)return!1;let r=n.source,i=n.target,a=e.find(e=>e.id===r),o=e.find(e=>e.id===i);return a&&o&&!h(a.type||`default`,o.type||`default`)?!1:ie(e.map(e=>({id:e.id})),t.map(e=>({source:e.source,target:e.target})),{source:r,target:i})},[e,t,h]);return{isConnecting:c,connectionMenu:f,setConnectionMenu:p,isValidConnection:g,onConnect:(0,l.useCallback)(e=>{if(!e.source||!e.target){console.warn(`Skipping invalid connection attempt: missing source or target`);return}if(g(e)){let t={...e,markerEnd:{type:u.MarkerType.ArrowClosed,width:20,height:20,color:`#888`}};n(e=>(0,u.addEdge)(t,e)),i&&i({id:`e-${e.source}-${e.target}`,source:e.source,target:e.target,data:{}})}},[n,g,i]),onConnectStart:(0,l.useCallback)((e,t)=>{m.current=t,d(!0)},[]),onConnectEnd:(0,l.useCallback)(e=>{if(d(!1),e.target.classList.contains(`react-flow__pane`)&&m.current&&s){let{clientX:t,clientY:n}=e;p({isOpen:!0,position:{x:t,y:n},source:{...m.current,handleType:m.current.handleType}})}},[s]),handleMenuAddNode:(0,l.useCallback)(e=>{if(!s)return;let{position:t,source:c}=f,l=s.screenToFlowPosition({x:t.x,y:t.y});l.x-=100,l.y-=50;let d=o.nodeDefinitions.find(t=>t.type===e),h=d?.width||250,g=d?.height||250,_=`node-${Date.now()}`,v={id:_,type:e,position:l,width:h,height:g,style:{width:`${h}px`,height:`${g}px`},data:{}};if(r(e=>e.concat(v)),a){let{nodes:e}=L([v],[]);e.length>0&&a(e[0])}if(c?.nodeId){let e;e=c.handleType===`target`?{id:`e-${_}-${c.nodeId}`,source:_,target:c.nodeId,targetHandle:c.handleId,markerEnd:{type:u.MarkerType.ArrowClosed,width:20,height:20,color:`#888`}}:{id:`e-${c.nodeId}-${_}`,source:c.nodeId,target:_,sourceHandle:c.handleId,markerEnd:{type:u.MarkerType.ArrowClosed,width:20,height:20,color:`#888`}},n(t=>(0,u.addEdge)(e,t)),i&&i({id:e.id,source:e.source,target:e.target,data:{}})}p(e=>({...e,isOpen:!1})),m.current=null},[f,s,r,n,a,i,o.nodeDefinitions]),availableNodeTypes:(0,l.useMemo)(()=>{let t=o.nodeDefinitions.map(e=>({type:e.type,label:e.label}));if(!f.source||!f.source.nodeId)return t;let n=f.source.nodeId,r=e.find(e=>e.id===n);if(!r)return t;let i=f.source.handleType;return t.filter(e=>i===`target`?h(e.type,r.type||`default`):h(r.type||`default`,e.type))},[o.nodeDefinitions,f.source,e,h])}}const K=l.default.forwardRef(({initialFlow:e,readOnly:t=!1,onChange:n,onSelectionChange:r,renderEmpty:i,onNodeAdd:a,onNodeCopy:o,onNodeMove:s,onNodeDelete:c,onNodeDataChange:d,onEdgeAdd:f,onEdgeDelete:p,onGroupAdd:m,onGroupDelete:h,onGroupUngroup:g,onGroupUpdate:_},x)=>{let{config:S,onNodeDataChange:C,getNodeContextMenuItems:w,getNodeMedia:T,updateNodeMedia:E}=le(),[D,O,k]=(0,u.useNodesState)([]),[A,M,N]=(0,u.useEdgesState)([]),[P,F]=(0,l.useState)(null),{isConnecting:ie,connectionMenu:z,setConnectionMenu:B,isValidConnection:V,onConnect:H,onConnectStart:W,onConnectEnd:se,handleMenuAddNode:ce,availableNodeTypes:ue}=me({nodes:D,edges:A,setEdges:M,setNodes:O,onEdgeAdd:f,onNodeAdd:a,config:S,rfInstance:P}),[G,K]=(0,l.useState)(null),[q,he]=(0,l.useState)(null),[J,ge]=(0,l.useState)({x:0,y:0}),[Y,X]=(0,l.useState)(null);(0,l.useEffect)(()=>{e&&(O(te(e.nodes,e.groups)),M(ne(e.edges)))},[]);let Z=(0,l.useRef)(n);(0,l.useEffect)(()=>{Z.current=n},[n]),(0,l.useEffect)(()=>{if(Z.current){let{nodes:e,groups:t}=L(D),n={nodes:e,edges:re(A),groups:t};Z.current(n)}},[D,A]),(0,l.useEffect)(()=>{let e=e=>{ge({x:e.clientX,y:e.clientY})};return window.addEventListener(`mousemove`,e),()=>window.removeEventListener(`mousemove`,e)},[]);let _e=(0,l.useMemo)(()=>{let e={group:fe};return S.nodeDefinitions.forEach(t=>{e[t.type]=de}),e},[S.nodeDefinitions]),ve=(0,l.useCallback)(e=>{k(e),e.forEach(e=>{e.type===`remove`&&c&&c(e.id)})},[k,c]),ye=(0,l.useCallback)(e=>{N(e),e.forEach(e=>{e.type===`remove`&&p&&p(e.id)})},[N,p]),Q=(0,l.useCallback)(({nodes:e})=>{if(e.length>0){let t=e[0];t.type===`group`?X(null):X(t.id)}else X(null);r&&r(e.filter(e=>e.type!==`group`).map(e=>e.id))},[r]),be=(0,l.useCallback)((e,t,n)=>{if(t.type===`group`){_&&_({id:t.id,position:t.position});return}if(s){let{nodes:e}=L(D),n=e.find(e=>e.id===t.id);n&&s(n)}},[s,_,D]),xe=(0,l.useCallback)(e=>{e.detail===2&&!t&&B({isOpen:!0,position:{x:e.clientX,y:e.clientY},source:null}),K(null)},[t]),Se=(0,l.useCallback)((e,t)=>{e.preventDefault(),e.stopPropagation(),K({isOpen:!0,position:{x:e.clientX,y:e.clientY},type:t.type===`group`?`group`:`node`,targetId:t.id})},[]),Ce=(0,l.useCallback)(e=>{e.preventDefault();let t=D.filter(e=>e.selected&&e.type!==`group`);K({isOpen:!0,position:{x:e.clientX,y:e.clientY},type:t.length>1?`multi`:`pane`})},[D]),we=(0,l.useCallback)((e,t)=>{e.preventDefault(),e.stopPropagation(),K({isOpen:!0,position:{x:e.clientX,y:e.clientY},type:`edge`,targetId:t.id})},[]),$=(0,l.useCallback)(()=>{let e=D.filter(e=>e.selected&&e.type!==`group`);if(e.length===0)return;let{nodes:t}=L(D),n=new Map(t.map(e=>[e.id,e])),r=new Set;e.forEach(e=>{e.data._groupId&&r.add(e.data._groupId)});let i=new Map;e.forEach(e=>{let t=n.get(e.id);t&&i.set(e.id,t)}),r.size>0&&t.forEach(e=>{e.groupId&&r.has(e.groupId)&&e.type!==`group`&&i.set(e.id,e)});let a=Array.from(i.values()),o=R(a.map(e=>({position:e.position,width:200,height:100}))),s=new Map(D.map(e=>[e.id,e])),c=R(a.map(e=>{let t=s.get(e.id);return{position:e.position,width:t?.measured?.width||t?.width,height:t?.measured?.height||t?.height}})),l=a.some(e=>{let t=s.get(e.id);return!!(t?.measured||t?.width||t?.height)})?c:o,u=I(`group`),d={id:u,label:`æ–°å»ºåˆ†ç»„`,position:{x:l.x-20,y:l.y-20},width:l.width+40,height:l.height+40};m&&m(d),r.forEach(e=>{h&&h(e)});let f={id:u,type:`group`,position:d.position,width:d.width,height:d.height,zIndex:-1,data:{label:d.label,_isGroup:!0},style:{width:d.width,height:d.height,zIndex:-1},selected:!0};O(e=>[f,...e.filter(e=>e.type!==`group`||!r.has(e.id)).map(e=>{if(i.has(e.id)){C&&C(e.id,{...e.data,_groupId:u});let t=n.get(e.id),r=t?.position.x??e.position.x,i=t?.position.y??e.position.y;return{...e,parentId:u,expandParent:!1,position:{x:r-d.position.x,y:i-d.position.y},selected:!1,data:{...e.data,_groupId:u}}}return e})]),K(null)},[D,O,m,h,C]),Te=(0,l.useCallback)(e=>{let t=e||G?.targetId||D.find(e=>e.selected&&e.type===`group`)?.id;if(!t)return;let{nodes:n}=L(D),r=new Map(n.map(e=>[e.id,e])),i=D.filter(e=>e.data?._groupId===t||e.parentId===t).map(e=>e.id);g&&g(t,i),O(e=>e.filter(e=>e.id!==t).map(e=>{if(e.data?._groupId===t||e.parentId===t){C&&C(e.id,{...e.data,_groupId:void 0});let t=r.get(e.id),n=t?.position.x??e.position.x,i=t?.position.y??e.position.y;return{...e,parentId:void 0,position:{x:n,y:i},data:{...e.data,_groupId:void 0}}}return e})),K(null)},[G,D,O,g,C]),Ee=(0,l.useCallback)(()=>{let e=G?.type===`node`?G.targetId:null;if(!e&&Y&&(e=Y),e){let t=D.find(t=>t.id===e);t&&he(t)}},[G,D,Y]),De=(0,l.useCallback)(()=>{if(q&&P){let e;e=G?P.screenToFlowPosition({x:G.position.x,y:G.position.y}):P.screenToFlowPosition({x:J.x,y:J.y});let t=q.id,n=I(),r={...q,id:n,position:e,selected:!0,data:{...q.data,_groupId:void 0}};O(e=>e.map(e=>({...e,selected:!1})).concat(r)),X(n);let i=T(t);if(i&&E&&E(n,{...i}),o&&o(t,n),a){let[e]=L([r]).nodes;a(e)}}},[q,P,G,J,O,a,o,T,E]),Oe=(0,l.useCallback)(()=>{let e,t=!1,n=!1;if(G)e=G.targetId,t=G.type===`edge`,n=G.type===`group`;else{let r=D.find(e=>e.selected),i=A.find(e=>e.selected);r?(e=r.id,n=r.type===`group`):i&&(e=i.id,t=!0)}if(e){if(t)M(t=>t.filter(t=>t.id!==e)),p&&p(e);else if(n){h&&h(e);let t=D.filter(t=>t.parentId===e||t.data?._groupId===e).map(e=>e.id);O(n=>n.filter(n=>n.id!==e&&!t.includes(n.id))),M(e=>e.filter(e=>!t.includes(e.source)&&!t.includes(e.target)))}else O(t=>t.filter(t=>t.id!==e)),M(t=>t.filter(t=>t.source!==e&&t.target!==e)),c&&c(e);K(null)}},[G,D,A,O,M,c,p,h]);(0,l.useEffect)(()=>{let e=e=>{if(t)return;let n=document.activeElement;n&&(n.tagName===`INPUT`||n.tagName===`TEXTAREA`||n.getAttribute(`contenteditable`)===`true`)||((e.ctrlKey||e.metaKey)&&e.key===`c`?Ee():(e.ctrlKey||e.metaKey)&&e.key===`v`?De():(e.ctrlKey||e.metaKey)&&e.key===`g`&&(e.preventDefault(),$()))};return window.addEventListener(`keydown`,e),()=>window.removeEventListener(`keydown`,e)},[Ee,De,$,t]);let ke=(0,l.useMemo)(()=>{let e=[],t=G?.type===`edge`;if(G?.type===`multi`&&e.push({label:`åˆ›å»ºåˆ†ç»„ (Group)`,onClick:$,icon:(0,U.jsx)(ee,{size:16}),shortcut:`Ctrl+G`}),(G?.type===`node`||G?.type===`edge`)&&e.push({label:`å¤åˆ¶ (Copy)`,onClick:Ee,disabled:G.type!==`node`,icon:(0,U.jsx)(y,{size:16}),shortcut:`Ctrl+C`}),(G?.type===`pane`||G?.type===`node`)&&e.push({label:`ç²˜è´´ (Paste)`,onClick:De,disabled:!q||t,icon:(0,U.jsx)(v,{size:16}),shortcut:`Ctrl+V`}),e.push({label:`åˆ é™¤ (Delete)`,onClick:Oe,icon:(0,U.jsx)(j,{size:16}),shortcut:`Del`}),G?.type===`group`&&e.push({label:`è§£æ•£åˆ†ç»„ (Ungroup)`,onClick:Te,icon:(0,U.jsx)(b,{size:16})}),G?.type===`node`&&G.targetId&&w&&D.find(e=>e.id===G.targetId)){let{nodes:t}=L(D),n=t.find(e=>e.id===G.targetId);if(n){let t=T(G.targetId),r=w(G.targetId,n,t);r.length>0&&r.forEach(t=>{e.push({label:t.label,onClick:t.onClick,disabled:t.disabled,icon:t.icon})})}}return e},[G,q,Ee,De,Oe,$,Te,D,w,T]);return l.default.useImperativeHandle(x,()=>({fitView:()=>P?.fitView(),getViewport:()=>P?.getViewport(),setFlow:e=>{O(te(e.nodes,e.groups)),M(ne(e.edges))},ungroup:e=>Te(e)}),[P,O,M,Te]),(0,U.jsxs)(`div`,{className:`canvas-flow-wrapper ${ie?`is-connecting`:``}`,style:{backgroundColor:S.style?.background},children:[(0,U.jsxs)(u.ReactFlow,{nodes:D,edges:A,onNodesChange:ve,onEdgesChange:ye,onConnect:H,onConnectStart:W,onConnectEnd:se,onNodeDragStop:be,isValidConnection:V,onPaneClick:xe,onNodeContextMenu:Se,onPaneContextMenu:Ce,onEdgeContextMenu:we,onInit:F,nodeTypes:_e,onSelectionChange:Q,fitView:!0,minZoom:.1,maxZoom:2.6,nodesDraggable:!t,nodesConnectable:!t,deleteKeyCode:[`Backspace`,`Delete`],selectionKeyCode:[`Shift`],noPanClassName:`nopan`,children:[(0,U.jsx)(u.Background,{}),(0,U.jsx)(pe,{selectedNodes:D.filter(e=>e.selected&&e.type!==`group`),onCreateGroup:$}),(0,U.jsx)(u.Controls,{}),D.length===0&&i&&(0,U.jsx)(`div`,{className:`cf-empty-state-overlay`,children:i})]}),z.isOpen&&(0,U.jsx)(ae,{position:z.position,onAddNode:ce,availableTypes:ue,onClose:()=>B(e=>({...e,isOpen:!1}))}),G?.isOpen&&(0,U.jsx)(oe,{items:ke,position:G.position,onClose:()=>K(null)})]})});K.displayName=`CanvasEditor`;var q=class{config;constructor(e){this.config=e}async runFlow(e,t){if(this.config.runFlow)return this.config.runFlow(e);let n={};for(let r of e.nodes){t?.(r.id,`running`);try{let i=await this.runSingleNode(r,e,n);n[r.id]=i,t?.(r.id,`success`)}catch(e){throw console.error(`Node ${r.id} execution failed:`,e),t?.(r.id,`error`),e}}return n}async runSingleNode(e,t,n){if(!this.config.runNode)return console.warn(`No runNode implementation provided, skipping execution`),{output:null};let r={node:e,flow:t,incoming:t.edges.filter(t=>t.target===e.id).map(e=>n[e.source]?.output)};return this.config.runNode(r)}},he=class{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){let n=this.listeners.get(e);n&&(n.delete(t),n.size===0&&this.listeners.delete(e))}emit(e,t){let n=this.listeners.get(e);n&&n.forEach(e=>e(t))}batchEmit(e){e.forEach(({nodeId:e,data:t})=>{this.emit(e,t)})}clear(){this.listeners.clear()}getListenerCount(){let e=0;return this.listeners.forEach(t=>{e+=t.size}),e}};const J=({title:e=`å°è¯•ï¼š`,items:t,onAction:n})=>{let[r,i]=(0,l.useState)(null);return(0,U.jsxs)(`div`,{className:`cf-node-empty-state`,children:[(0,U.jsx)(`div`,{className:`cf-node-empty-title`,children:e}),(0,U.jsx)(`div`,{className:`cf-node-empty-menu`,children:t.map(e=>{let t=r===e.id,a=e.icon;return(0,U.jsxs)(`div`,{className:`cf-menu-item ${t?`hovered`:``}`,onMouseEnter:()=>i(e.id),onMouseLeave:()=>i(null),onClick:t=>{t.stopPropagation(),n(e.id)},children:[(0,U.jsx)(`span`,{className:`cf-menu-item-icon`,children:(0,U.jsx)(a,{size:14})}),(0,U.jsx)(`span`,{className:`cf-menu-item-label`,children:e.label}),t&&(0,U.jsx)(`span`,{className:`cf-menu-item-arrow`,children:(0,U.jsx)(_,{size:14})})]},e.id)})})]})},ge=({data:e,isConnected:t,onChange:n})=>{let[r,i]=(0,l.useState)(!1),a=t||e.isInteracted||!!e.text,o=[{id:`edit`,icon:E,label:`è‡ªå·±ç¼–å†™å†…å®¹`},{id:`text-to-video`,icon:P,label:`æ–‡ç”Ÿè§†é¢‘`},{id:`image-to-prompt`,icon:x,label:`å›¾ç‰‡åæŽ¨æç¤ºè¯`},{id:`text-to-audio`,icon:T,label:`æ–‡ç”ŸéŸ³ä¹`}];return a?(0,U.jsx)(`div`,{className:`cf-text-node-container`,onDoubleClick:()=>i(!0),children:r?(0,U.jsx)(`textarea`,{className:`nodrag cf-text-node-input`,autoFocus:!0,onBlur:()=>i(!1),placeholder:`è¾“å…¥æ–‡æœ¬æˆ–è€…ç¼–è¾‘ç”Ÿæˆç»“æžœ...`,value:e.text||``,onChange:e=>n({text:e.target.value}),onKeyDown:e=>e.stopPropagation()}):(0,U.jsxs)(U.Fragment,{children:[(0,U.jsx)(`div`,{className:`cf-text-node-display ${e.text?``:`placeholder`}`,children:e.text||`åŒå‡»è¾“å…¥æ–‡æœ¬...`}),(0,U.jsx)(`div`,{className:`cf-text-node-overlay`,children:`åŒå‡»ç¼–è¾‘`})]})}):(0,U.jsx)(J,{items:o,onAction:e=>{e===`edit`?(n({isInteracted:!0}),i(!0)):console.log(`Action triggered:`,e)}})},Y=({isOpen:e,onClose:t,src:n,type:r})=>((0,l.useEffect)(()=>(e?document.body.style.overflow=`hidden`:document.body.style.overflow=`unset`,()=>{document.body.style.overflow=`unset`}),[e]),!e||!n?null:(0,d.createPortal)((0,U.jsx)(`div`,{className:`cf-media-modal-overlay`,onClick:t,children:(0,U.jsxs)(`div`,{className:`cf-media-modal-content`,onClick:e=>e.stopPropagation(),children:[(0,U.jsx)(`button`,{className:`cf-media-modal-close`,onClick:t,children:(0,U.jsx)(F,{size:24})}),(0,U.jsxs)(`div`,{className:`cf-media-modal-body`,children:[r===`image`&&(0,U.jsx)(`img`,{src:n,alt:`Preview`,className:`cf-media-modal-image`}),r===`video`&&(0,U.jsx)(`video`,{src:n,controls:!0,className:`cf-media-modal-video`,autoPlay:!0}),r===`audio`&&(0,U.jsxs)(`div`,{className:`cf-media-modal-audio-wrapper`,children:[(0,U.jsx)(`div`,{className:`cf-media-modal-audio-icon`,children:`ðŸŽµ`}),(0,U.jsx)(`audio`,{src:n,controls:!0,className:`cf-media-modal-audio`,autoPlay:!0})]})]})]})}),document.body)),X=({data:e,isConnected:t,onChange:n})=>{let r=(0,l.useRef)(null),[i,a]=(0,l.useState)(!1),o=[{id:`img-to-img`,icon:x,label:`å›¾ç”Ÿå›¾`},{id:`img-to-video`,icon:x,label:`å›¾ç”Ÿè§†é¢‘`},{id:`remove-bg`,icon:S,label:`å›¾ç‰‡æ¢èƒŒæ™¯`},{id:`first-frame-video`,icon:P,label:`é¦–å¸§å›¾ç”Ÿè§†é¢‘`}],s=e.src||e.output;return s||t?(0,U.jsxs)(U.Fragment,{children:[(0,U.jsx)(`div`,{className:`cf-media-node-container`,onDoubleClick:()=>s&&a(!0),title:`åŒå‡»æŸ¥çœ‹å¤§å›¾`,children:s&&(0,U.jsx)(`img`,{ref:r,src:s,alt:`generated`,className:`cf-media-node-content`,onLoad:e=>{let t=e.currentTarget;t.naturalWidth&&t.naturalHeight&&n({_contentSize:{width:t.naturalWidth,height:t.naturalHeight}})},style:{display:`block`,cursor:`zoom-in`}})}),(0,U.jsx)(Y,{isOpen:i,onClose:()=>a(!1),src:s,type:`image`})]}):(0,U.jsx)(J,{items:o,onAction:e=>console.log(`Image action:`,e)})},Z=({data:e,isConnected:t,onChange:n})=>{let r=(0,l.useRef)(null),[i,a]=(0,l.useState)(!1),o=[{id:`first-last-frame-to-video`,icon:S,label:`é¦–å°¾å¸§ç”Ÿæˆè§†é¢‘`},{id:`first-frame-to-video`,icon:A,label:`é¦–å¸§ç”Ÿæˆè§†é¢‘`}],s=t||e.output||e.src,c=e.src||e.output;return s?(0,U.jsxs)(U.Fragment,{children:[(0,U.jsx)(`div`,{className:`cf-media-node-container`,title:`åŒå‡»å…¨å±é¢„è§ˆ`,children:c&&(0,U.jsx)(`video`,{ref:r,src:c,controls:!0,controlsList:`nofullscreen`,className:`cf-media-node-content`,onLoadedMetadata:e=>{let t=e.currentTarget;t.videoWidth&&t.videoHeight&&n({_contentSize:{width:t.videoWidth,height:t.videoHeight}})},style:{display:`block`},onDoubleClick:e=>{e.preventDefault(),e.stopPropagation(),c&&a(!0)}})}),(0,U.jsx)(Y,{isOpen:i,onClose:()=>a(!1),src:c,type:`video`})]}):(0,U.jsx)(J,{items:o,onAction:e=>console.log(`Video action:`,e)})},_e=({data:e,isConnected:t})=>{let[n,r]=(0,l.useState)(!1),i=[{id:`audio-to-video`,icon:T,label:`éŸ³é¢‘ç”Ÿè§†é¢‘`}],a=t||e.output||e.src,o=e.src||e.output;return a?(0,U.jsxs)(U.Fragment,{children:[(0,U.jsx)(`div`,{className:`cf-media-node-container`,onDoubleClick:()=>o&&r(!0),title:`åŒå‡»æ‰“å¼€æ’­æ”¾å™¨`,style:{cursor:`pointer`},children:o&&(0,U.jsx)(`audio`,{src:o,controls:!0,className:`cf-media-node-content`,style:{width:`100%`,marginTop:`auto`,marginBottom:`auto`}})}),(0,U.jsx)(Y,{isOpen:n,onClose:()=>r(!1),src:o,type:`audio`})]}):(0,U.jsx)(J,{items:i,onAction:e=>console.log(`Audio action:`,e)})},ve=({data:e,onChange:t})=>{let[n,r]=(0,l.useState)(!1),i=e._uploading||!1,a=e._uploadError,o=e=>{let n=e.target.files?.[0];if(!n)return;let r=n.type.startsWith(`image/`),i=n.type.startsWith(`video/`);if(!r&&!i){t({_uploadError:`åªæ”¯æŒå›¾ç‰‡å’Œè§†é¢‘æ–‡ä»¶`});return}t({_uploadRequest:n,fileName:n.name,fileType:n.type,_uploadError:null})},s=e=>{e.stopPropagation(),t({src:null,fileName:null,fileType:null,output:null,_uploadError:null})},c=()=>{let t=e.src||e.output;if(!t)return null;let n=e.fileType||``,r=(e=>{let t=e.split(`?`)[0].split(`.`).pop()?.toLowerCase();return[`jpg`,`jpeg`,`png`,`gif`,`webp`,`svg`,`bmp`].includes(t||``)?`image`:[`mp4`,`webm`,`mov`,`avi`,`mkv`,`m4v`].includes(t||``)?`video`:`unknown`})(t),i=n.startsWith(`video/`)||r===`video`,a=n.startsWith(`image/`)||r===`image`;return i?(0,U.jsx)(`video`,{src:t,className:`cf-upload-preview-video`,controls:!0}):a?(0,U.jsx)(`img`,{src:t,alt:`uploaded`,className:`cf-upload-preview-image`,onError:e=>{console.error(`Image load failed:`,t)}}):(0,U.jsx)(`div`,{className:`cf-upload-preview-file`,children:e.fileName||`æœªçŸ¥æ–‡ä»¶`})},u=e.src||e.output;return(0,U.jsxs)(`div`,{className:`cf-upload-container ${u?`has-content`:``}`,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),children:[i&&(0,U.jsxs)(`div`,{className:`cf-upload-loading-overlay`,children:[(0,U.jsx)(`div`,{className:`cf-spinner`}),(0,U.jsx)(`span`,{children:`ä¸Šä¼ ä¸­...`})]}),a&&!i&&(0,U.jsx)(`div`,{className:`cf-upload-error-overlay`,children:(0,U.jsxs)(`span`,{children:[`âš ï¸ `,a]})}),u?(0,U.jsxs)(`div`,{className:`cf-upload-content-wrapper`,children:[c(),n&&!i&&(0,U.jsx)(`div`,{onClick:s,className:`cf-upload-delete-btn`,title:`ç§»é™¤æ–‡ä»¶`,children:(0,U.jsx)(F,{size:14})})]}):(0,U.jsxs)(`label`,{className:`cf-upload-placeholder`,children:[(0,U.jsx)(`input`,{type:`file`,style:{display:`none`},onChange:o,accept:`image/*,video/*`,disabled:i}),(0,U.jsxs)(`div`,{style:{display:`flex`,gap:8,alignItems:`center`,marginBottom:8},children:[(0,U.jsx)(x,{size:20,strokeWidth:1.5}),(0,U.jsx)(P,{size:20,strokeWidth:1.5})]}),(0,U.jsx)(N,{size:24}),(0,U.jsx)(`span`,{className:`cf-upload-label-text`,children:`ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘`}),(0,U.jsx)(`span`,{className:`cf-upload-subtext`,style:{fontSize:10,color:`#666`,marginTop:4},children:`æ”¯æŒ JPGã€PNGã€MP4 ç­‰æ ¼å¼`})]})]})},ye=({actions:e,className:t=``,style:n,visible:r=!0})=>!r||e.length===0?null:(0,U.jsx)(`div`,{className:`canvas-node-toolbar ${t}`,style:n,onMouseDown:e=>e.stopPropagation(),children:e.map(e=>{let t=e.icon;return(0,U.jsxs)(`button`,{className:`canvas-node-toolbar-item ${e.className||``}`,onClick:e.onClick,title:e.title||e.label,children:[e.icon&&(0,U.jsx)(`span`,{className:`toolbar-item-icon`,children:l.default.isValidElement(e.icon)?e.icon:(0,U.jsx)(t,{size:14})}),e.label&&(0,U.jsx)(`span`,{className:`toolbar-item-label`,children:e.label})]},e.id)})}),Q=e=>{switch(e){case z.TEXT:return{text:``,resourceType:`text/plain`};case z.IMAGE:return{src:``,resourceType:`image/png`};case z.VIDEO:return{src:``,resourceType:`video/mp4`};case z.AUDIO:return{src:``,resourceType:`audio/mp3`};case z.UPLOAD:return{src:``,resourceType:``};default:return{}}},be={TextNode:ge,ImageNode:X,VideoNode:Z,AudioNode:_e,UploadNode:ve},xe={style:{background:`#0f1115`},nodeDefinitions:[{type:z.TEXT,label:`æ–‡æœ¬`,component:`TextNode`,width:280,height:220,defaultData:Q(z.TEXT),connectionRules:{allowedTargets:[z.IMAGE,z.VIDEO]}},{type:z.IMAGE,label:`å›¾ç‰‡`,component:`ImageNode`,width:260,height:260,defaultData:Q(z.IMAGE),connectionRules:{allowedSources:[z.TEXT,z.UPLOAD],allowedTargets:[z.VIDEO]}},{type:z.VIDEO,label:`è§†é¢‘`,component:`VideoNode`,width:300,height:200,defaultData:Q(z.VIDEO),connectionRules:{allowedSources:[z.TEXT,z.IMAGE]}},{type:z.UPLOAD,label:`ä¸Šä¼ `,component:`UploadNode`,width:240,height:200,defaultData:Q(z.UPLOAD)}]},Se=l.default.forwardRef((e,t)=>{let{initialFlow:n={nodes:[],edges:[]},config:r=xe,components:i=be,execution:a={},mode:o=`edit`,ui:s={showToolbar:!0},renderEmpty:c,renderNodeInspector:u,onChange:d,onSave:f,onRunFlow:p,onNodeRun:m,onGroupRun:h,onGroupSave:g,onSelectionChange:_,onNodeAdd:v,onNodeCopy:y,onNodeDelete:ee,onNodeMove:b,onNodeDataChange:x,onEdgeAdd:S,onEdgeDelete:C,onGroupAdd:w,onGroupDelete:T,onGroupUngroup:E,onGroupUpdate:D,getNodeContextMenuItems:O,className:k,style:A}=e,[j,M]=(0,l.useState)(n),[N,P]=(0,l.useState)(!1),[F,te]=(0,l.useState)(null),[L,ne]=(0,l.useState)(null),re=(0,l.useRef)(new q(a)),R=(0,l.useRef)(null),ie=(0,l.useRef)(``),z=(0,l.useRef)(new Map),B=(0,l.useRef)(new he),V=(0,l.useCallback)(e=>{let t=R.current?.getFlow?.()||j;return!t||!t.nodes?null:t.nodes.find(t=>t.id===e)||null},[j]),H=(0,l.useCallback)((e,t,n)=>{let r=V(e);if(!r)return console.warn(`[${n}] èŠ‚ç‚¹ä¸å­˜åœ¨: ${e}`),null;let i=Array.isArray(t)?t:[t];return i.includes(r.type)?r:(console.error(`[${n}] èŠ‚ç‚¹ ${e} çš„ç±»åž‹æ˜¯ "${r.type}"ï¼Œä¸ç¬¦åˆè¦æ±‚ã€‚`,`æœŸæœ›çš„ç±»åž‹: ${i.join(`, `)}`),null)},[V]),W=(0,l.useCallback)((e,t)=>{let n=[`src`,`text`,`title`,`outputData`,`output`,`_loading`,`_error`,`_executionStatus`,`_contentSize`,`fileName`,`fileType`,`fileSize`,`_uploading`,`_uploadError`,`resourceType`],r=z.current.get(e)||{},i={...r};console.log(`[Core updateMediaData] èŠ‚ç‚¹ ${e}:`,{currentMedia:r,updates:t,willMerge:i}),Object.keys(t).forEach(r=>{n.includes(r)?t[r]===void 0?delete i[r]:i[r]=t[r]:console.warn(`[updateMediaData] å¿½ç•¥éžåª’ä½“å­—æ®µ "${r}" (èŠ‚ç‚¹ ${e})`,`\nå…è®¸çš„å­—æ®µ: ${n.join(`, `)}`)}),z.current.set(e,i),B.current.emit(e,i),console.log(`[Core updateMediaData] æ›´æ–°åŽ:`,i)},[]);(0,l.useImperativeHandle)(t,()=>({init:(e,t)=>{let n=t||I();return ie.current=n,e&&(M(e),R.current?.setFlow&&(R.current.setFlow(e),setTimeout(()=>{R.current?.fitView()},10))),n},getFlow:()=>R.current?.getFlow?.()||j,setFlow:e=>{M(e),R.current?.setFlow&&R.current.setFlow(e)},runFlow:async()=>se(),fitView:()=>{R.current?.fitView()},getViewport:()=>R.current?.getViewport()||{x:0,y:0,zoom:1},getNode:e=>{let t=R.current?.getFlow?.()||j;return!t||!t.nodes?null:t.nodes.find(t=>t.id===e)||null},getUpstreamNodes:e=>{let t=R.current?.getFlow?.();if(!t)return[];let n=t.edges.filter(t=>t.target===e).map(e=>e.source);return t.nodes.filter(e=>n.includes(e.id)).map(e=>{let t=r.nodeDefinitions.find(t=>t.type===e.type),n=z.current.get(e.id)||{};return{id:e.id,type:e.type,label:t?.label||e.type,position:e.position,data:n}})},setNodeImage:(e,t)=>{H(e,[`image`,`video`,`audio`,`user-upload`],`setNodeImage`)&&W(e,{src:t})},setNodeVideo:(e,t)=>{H(e,`video`,`setNodeVideo`)&&W(e,{src:t})},setNodeAudio:(e,t)=>{H(e,`audio`,`setNodeAudio`)&&W(e,{src:t})},setNodeText:(e,t)=>{H(e,`text`,`setNodeText`)&&W(e,{text:t})},setNodeTitle:(e,t)=>{V(e)?W(e,{title:t}):console.warn(`[setNodeTitle] èŠ‚ç‚¹ä¸å­˜åœ¨: ${e}`)},setNodeOutput:(e,t)=>{V(e)?W(e,{outputData:t}):console.warn(`[setNodeOutput] èŠ‚ç‚¹ä¸å­˜åœ¨: ${e}`)},setUploadNodeSrc:(e,t,n)=>{if(!H(e,`user-upload`,`setUploadNodeSrc`))return;let r={src:t,_uploading:!1,_uploadError:null};n&&(n.fileName&&(r.fileName=n.fileName),n.fileType&&(r.fileType=n.fileType),n.fileSize&&(r.fileSize=n.fileSize)),W(e,r),console.log(`[setUploadNodeSrc] è®¾ç½®ä¸Šä¼ èŠ‚ç‚¹ ${e} çš„åª’ä½“æº:`,t)},setUploadNodeLoading:(e,t)=>{H(e,`user-upload`,`setUploadNodeLoading`)&&(W(e,{_uploading:t,_uploadError:t?null:void 0}),console.log(`[setUploadNodeLoading] è®¾ç½®ä¸Šä¼ èŠ‚ç‚¹ ${e} åŠ è½½çŠ¶æ€:`,t))},setUploadNodeError:(e,t)=>{H(e,`user-upload`,`setUploadNodeError`)&&(W(e,{_uploadError:t,_uploading:!1}),console.log(`[setUploadNodeError] è®¾ç½®ä¸Šä¼ èŠ‚ç‚¹ ${e} é”™è¯¯:`,t))},clearUploadNode:e=>{H(e,`user-upload`,`clearUploadNode`)&&(W(e,{src:void 0,fileName:void 0,fileType:void 0,fileSize:void 0,output:void 0,_uploading:void 0,_uploadError:void 0}),console.log(`[clearUploadNode] æ¸…ç©ºä¸Šä¼ èŠ‚ç‚¹ ${e}`))},setNodeContent:(e,t)=>{W(e,t)},clearNodeContent:e=>{let{src:t,text:n,outputData:r,...i}=z.current.get(e)||{};z.current.set(e,i),B.current.emit(e,i)},setNodeLoading:e=>{let t=z.current.get(e)||{};z.current.set(e,{...t,_loading:!0}),B.current.emit(e,z.current.get(e))},clearNodeLoading:e=>{let t=z.current.get(e)||{};console.log(`[Core clearNodeLoading] èŠ‚ç‚¹ ${e} æ¸…é™¤å‰:`,t);let n={...t};delete n._loading,z.current.set(e,n),B.current.emit(e,n),console.log(`[Core clearNodeLoading] èŠ‚ç‚¹ ${e} æ¸…é™¤åŽ:`,n)},setNodeError:(e,t)=>{let n=z.current.get(e)||{};z.current.set(e,{...n,_error:t}),B.current.emit(e,z.current.get(e))},clearNodeError:e=>{let t={...z.current.get(e)||{}};delete t._error,z.current.set(e,t),B.current.emit(e,t)},updateNodeMedia:(e,t)=>{let n={...z.current.get(e)||{},...t};Object.keys(n).forEach(e=>{n[e]===void 0&&delete n[e]}),z.current.set(e,n),B.current.emit(e,n)},batchUpdateNodeMedia:e=>{e.forEach(({nodeId:e,data:t})=>{let n={...z.current.get(e)||{},...t};z.current.set(e,n)}),B.current.batchEmit(e.map(e=>({nodeId:e.nodeId,data:z.current.get(e.nodeId)})))},getNodeMedia:e=>z.current.get(e)||{},updateNodeStatus:(e,t)=>{let n={...z.current.get(e)||{},_executionStatus:t};z.current.set(e,n),B.current.emit(e,n)}}),[j,r,V,H,W]);let ae=(0,l.useCallback)(e=>{M(e),d?.(e)},[d]),oe=(0,l.useCallback)(e=>{e.length===1?ne(e[0]):ne(null),_?.(e)},[_]),se=async()=>{if(!N){P(!0),p?.(j);try{return await re.current.runFlow(j,(e,t)=>{})}catch(e){console.error(`Flow execution failed`,e)}finally{P(!1)}}},le=async e=>{if(N)return;if(h){P(!0);try{await h(e)}catch(t){console.error(`Group ${e} execution failed`,t)}finally{P(!1)}return}let t=j.nodes.filter(t=>t.groupId===e);if(t.length===0)return;let n=new Set(t.map(e=>e.id)),r={nodes:t,edges:j.edges.filter(e=>n.has(e.source)&&n.has(e.target)),groups:[],meta:j.meta};P(!0);try{await re.current.runFlow(r,(e,t)=>{})}catch(t){console.error(`Group ${e} execution failed`,t)}finally{P(!1)}},ue=async e=>{if(!F){te(e);try{m?await m(e):console.warn(`No onNodeRun handler provided`)}catch(e){console.error(`Node execution failed:`,e)}finally{te(null)}}},G=(0,l.useCallback)((e,t)=>{switch(e){case`create`:w?.(t);break;case`delete`:T?.(t);break;case`update`:case`move`:D?.(t);break;case`ungroup`:R.current?.ungroup&&R.current.ungroup(t.id);break;case`run`:le(t.id);break;case`save`:let e=j.groups?.find(e=>e.id===t.id);if(!e){console.warn(`Group ${t.id} not found for save`);return}let n=j.nodes.filter(e=>e.groupId===t.id),r=new Set(n.map(e=>e.id)),i={nodes:n,edges:j.edges.filter(e=>r.has(e.source)&&r.has(e.target)),groups:[e],meta:j.meta};g?.(t.id,i);break}},[w,T,D,j,h,g]),de=(0,l.useCallback)(e=>z.current.get(e)||{},[]),fe=(0,l.useCallback)((e,t)=>{let n=z.current.get(e)||{};console.log(`[Core updateNodeMedia] èŠ‚ç‚¹ ${e}:`,{currentMedia:n,newMedia:t,willMerge:{...n,...t}});let r={...n,...t};Object.keys(r).forEach(e=>{r[e]===void 0&&delete r[e]}),z.current.set(e,r),B.current.emit(e,r),console.log(`[Core updateNodeMedia] æ›´æ–°åŽçš„ mediaMap:`,r)},[]);return(0,U.jsx)(ce,{config:r,components:i,readOnly:o===`view`,onNodeRun:ue,onNodeDataChange:x,runningNodeId:F,isExecuting:N||!!F,onGroupAction:G,inspectingNodeId:L,mediaMap:z.current,mediaEmitter:B.current,getNodeMedia:de,updateNodeMedia:fe,renderNodeInspector:u,getNodeContextMenuItems:O,children:(0,U.jsx)(`div`,{className:`canvas-flow-container ${k||``}`,style:{width:`100%`,height:`100%`,position:`relative`,overflow:`hidden`,...A},children:(0,U.jsx)(K,{ref:R,initialFlow:n,readOnly:o===`view`,renderEmpty:c,onChange:ae,onSelectionChange:oe,onNodeAdd:v,onNodeCopy:y,onNodeMove:b,onNodeDelete:ee,onNodeDataChange:x,onEdgeAdd:S,onEdgeDelete:C,onGroupAdd:w,onGroupDelete:T,onGroupUngroup:E,onGroupUpdate:D})})})});Se.displayName=`CanvasFlow`;const Ce=({onAction:e})=>(0,U.jsx)(`div`,{className:`cf-canvas-empty-state`,children:(0,U.jsxs)(`div`,{className:`cf-empty-instruction`,children:[(0,U.jsxs)(`div`,{className:`cf-double-click-badge`,children:[(0,U.jsx)(w,{size:14}),(0,U.jsx)(`span`,{children:`åŒå‡»`})]}),(0,U.jsx)(`span`,{className:`cf-instruction-text`,children:`ç”»å¸ƒè‡ªç”±ç”Ÿæˆ,æˆ–æŸ¥çœ‹å·¥ä½œæµæ¨¡æ¿`})]})});exports.ActionToolbar=ye,exports.AudioNode=_e,exports.CanvasEmptyState=Ce,exports.CanvasFlow=Se,exports.FloatingNodeMenu=ae,exports.GroupNode=fe,exports.ImageNode=X,exports.NodeEmptyState=J,exports.NodeMediaEmitter=he,exports.NodeTitleEditor=ue,exports.StandardNodeType=z,exports.TextNode=ge,exports.UploadNode=ve,exports.VideoNode=Z,exports.defaultCanvasConfig=xe,exports.defaultComponentRegistry=be;